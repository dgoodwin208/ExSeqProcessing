# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

.SUFFIXES: .cu

#GTEST_DIR=/mp/nas1/share/lib/googletest/googletest
GTEST_DIR=/home/kajita

CPPFLAGS+=-isystem $(GTEST_DIR)/include
CXXFLAGS+=-g -std=c++11 -Wall -Wextra -pthread -Wno-unused-function
NVCCFLAGS=-g -std=c++11 --gpu-architecture=sm_61 -Xcompiler="-Wno-unused-function"

CUDA_INC=/usr/local/cuda/include
CUDA_LIB=/usr/local/cuda/lib64

SPDLOG_DIR=../../include
CUDA_UTILS_DIR=../../cuda-utils

TESTS=gtest_sift

GTEST_HEADERS=$(GTEST_DIR)/include/gtest/*.h \
              $(GTEST_DIR)/include/gtest/internal/*.h
#GTEST_LIBS=$(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a
GTEST_LIBS=$(GTEST_DIR)/lib64/libgtest_main.a $(GTEST_DIR)/lib64/libgtest.a


all: $(TESTS)

clean:
	rm -f $(TESTS) *.o


#gtest_cudautils_kernel.o : gtest_cudautils_kernel.cu $(GTEST_HEADERS)
#	nvcc $(CPPFLAGS) $(NVCCFLAGS) -I$(CUDAUTILS_DIR) -I$(SPDLOG_DIR) -c gtest_cudautils_kernel.cu
#
#gtest_cudautils_kernel : gtest_cudautils_kernel.o $(CUDAUTILS_DIR)/libcudautils_test.a
#	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread -o $@ $^ -L$(CUDA_LIB) -lcudart

gtest_sift.o: gtest_sift.cu $(GTEST_HEADERS)
	nvcc $(NVCCFLAGS) $(CPPFLAGS) -I$(CUDA_UTILS_DIR) -I$(SPDLOG_DIR) -I.. -g -G -c $<

gtest_sift: gtest_sift.o ../sift.o $(CUDA_UTILS_DIR)/libcudautils.a
	$(CXX) $(CXXFLAGS) $(GTEST_LIBS) -lpthread -o $@ $^ -L$(CUDA_LIB) -lcudart


