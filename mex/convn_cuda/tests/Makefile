# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

#GTEST_DIR = /mp/nas1/share/lib/googletest/googletest
GTEST_DIR = /home/kajita

CPPFLAGS += -std=c++11 -isystem $(GTEST_DIR)/include
CXXFLAGS += -g -Wall -Wextra -pthread -O3 -no-pie
NVCC = /usr/local/cuda/bin/nvcc
NVCC_FLAGS = -g -Xcompiler -fPIC --gpu-architecture=sm_61 -std=c++11 -lineinfo 

CUDA_INC = /usr/local/cuda/include
CUDA_LIB = /usr/local/cuda/lib64

SPDLOG_DIR = ../../include

UTILS_DIR = ../utils
CUFFT_DIR = ../cufft-utils
CUDAUTILS_DIR = ../../cuda-utils
#CUDNNUTILS_DIR = ../cudnn-utils

TESTS = gtest_cufftutils # gtest_cudautils  

GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h


all : $(TESTS)

clean :
	rm -f $(TESTS) *.o

gtest_cufftutils.o : gtest_cufftutils.cu $(GTEST_HEADERS)
	$(NVCC) $(NVCC_FLAGS) -c $< -L$(CUDA_LIB) -lcufft -I$(CUDA_INC) -I$(CUFFT_DIR) -I$(SPDLOG_DIR) -I$(GTEST_DIR)/include -I$(CUDAUTILS_DIR)
	#$(CXX) $(CPPFLAGS) -c gtest_cufftutils.cpp -L$(CUDA_LIB) -lcufft -I$(CUDA_INC) -I$(CUFFT_DIR) -I$(SPDLOG_DIR)

gtest_cufftutils : gtest_cufftutils.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $< -o $@ $(GTEST_DIR)/lib64/libgtest_main.a $(GTEST_DIR)/lib64/libgtest.a $(CUFFT_DIR)/libcufftutils.a -I$(CUDA_INC) -I$(CUFFT_DIR) -L$(CUDA_LIB) -L$(CUFFT_DIR) -lcufft -lcudart -lpthread -lcufftutils 

#gtest_cudautils.o : gtest_cudautils.cpp $(GTEST_HEADERS)
	#$(CXX) $(CPPFLAGS) -I$(CUDNNUTILS_DIR) -I$(CUDAUTILS_DIR) -I$(SPDLOG_DIR) -c gtest_cudautils.cpp

#gtest_cudautils : $(CUDAUTILS_DIR)/convn.o $(CUDNNUTILS_DIR)/libcudnnutils.a gtest_cudautils.o
	#$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread -o $@ $(CUDNNUTILS_DIR)/libcudnnutils.a -L$(CUDA_LIB) -lcudnn -lcudart -ltbb

