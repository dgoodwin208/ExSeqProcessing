# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

.SUFFIXES: .cu

GTEST_DIR=/mp/nas1/share/lib/googletest/googletest

CUDA_INC=/usr/local/cuda/include
CUDA_LIB=/usr/local/cuda/lib64

SPDLOG_DIR=../../include
CUDA_UTILS_DIR=../../cuda-utils

CPPFLAGS+=-isystem $(GTEST_DIR)/include -I$(CUDA_UTILS_DIR) -I$(SPDLOG_DIR) -I..
CXXFLAGS+=-g -std=c++11 -Wall -Wextra -pthread
NVCCFLAGS=-g -std=c++11 --gpu-architecture=sm_61

TESTS=gtest_cudautils_kernel gtest_cudautils

GTEST_HEADERS=$(GTEST_DIR)/include/gtest/*.h \
              $(GTEST_DIR)/include/gtest/internal/*.h
GTEST_LIBS=$(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a


all: $(TESTS)

clean:
	rm -f $(TESTS) *.o


nnsearch2_test.o: ../nnsearch2.cu ../nnsearch2.h
	nvcc $(NVCCFLAGS) $(CPPFLAGS) -D DEBUG_DIST_CHECK -Xcompiler -fPIC -c -o $@ $<

gtest_cudautils_kernel.o: gtest_cudautils_kernel.cu $(GTEST_HEADERS)
	nvcc $(NVCCFLAGS) $(CPPFLAGS) -c $<

gtest_cudautils_kernel: gtest_cudautils_kernel.o nnsearch2_test.o $(CUDA_UTILS_DIR)/libcudautils.a
	$(CXX) $(CXXFLAGS) $(GTEST_LIBS) -lpthread -o $@ $^ -L$(CUDA_LIB) -lcudart


gtest_cudautils.o: gtest_cudautils.cu $(GTEST_HEADERS)
	nvcc $(NVCCFLAGS) $(CPPFLAGS) -c $<

gtest_cudautils: gtest_cudautils.o nnsearch2_test.o $(CUDA_UTILS_DIR)/libcudautils.a
	$(CXX) $(CXXFLAGS) $(GTEST_LIBS) -lpthread -o $@ $^ -L$(CUDA_LIB) -lcudart


